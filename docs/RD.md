# 🍫 Valentine Strategy Dashboard — 要件定義書

**プロジェクト:** AI職場Hack  
**作成日:** 2025年2月  
**ステータス:** Draft v1.0

---

## 1. プロジェクト概要

### 1.1 背景・目的

AI職場Hack社内プロジェクトにおいて、LLM活用の実践例として「バレンタイン最適化戦略ダッシュボード」を開発する。バレンタインのギフト戦略を題材に、LLMによるデータ分析・最適化・テキスト生成の実用性をデモンストレーションする。

本アプリのコアロジックはそのままセールス領域に応用可能であり、リード分析・提案内容の最適化・コミュニケーション設計への展開を見据える。

### 1.2 コンセプト

「誰に・何を・どう渡すか」をAIが最適化する。ユーザーが相手リストと予算を入力すると、LLMが以下を一括分析・生成する。

- 優先度スコアリング（S/A/B/Cランク）
- 予算配分の最適化
- ギフト提案（商品カテゴリ + 価格帯 + 理由）
- メッセージ文面生成
- ホワイトデー回収予測（ROI）
- スケジュール・リスク警告

### 1.3 セールス応用対比

| バレンタイン機能          | セールス応用             | 共通ロジック       |
| ------------------------- | ------------------------ | ------------------ |
| 相手リスト                | リード/顧客リスト        | ターゲット分析     |
| S/A/B/Cランク             | ホット/ウォーム/コールド | 優先度スコアリング |
| 予算配分                  | リソースアロケーション   | 最適化アルゴリズム |
| ギフト提案                | 提案内容の最適化         | パーソナライズ     |
| メッセージ生成            | 営業メール自動生成       | テキスト生成       |
| ROI（ホワイトデー回収率） | LTV / 受注率             | 投資対効果予測     |

---

## 2. 技術スタック

### 2.1 アーキテクチャ構成

| レイヤー       | 技術                            | 備考                                 |
| -------------- | ------------------------------- | ------------------------------------ |
| フロントエンド | Next.js (App Router)            | React 18+ / TypeScript               |
| ホスティング   | Vercel                          | フロント + API Routesのデプロイ先    |
| データベース   | Supabase (PostgreSQL)           | 分析結果の保存・デモデータ管理       |
| LLM基盤        | Dify (Cloud or Self-host)       | ワークフローで分析パイプラインを構築 |
| LLMモデル      | Claude Sonnet 4.5 または GPT-4o | Dify経由で呼び出し                   |
| UIライブラリ   | shadcn/ui + Tailwind CSS        | ダッシュボードUIコンポーネント       |
| チャート       | Recharts                        | 予算配分グラフ等の可視化             |

### 2.2 システム構成図

```
[User Browser]
    ↓
[Next.js on Vercel]
    ├── Frontend: 入力フォーム + ダッシュボードUI
    ├── API Routes: /api/analyze
    │       ↓
    │   [Dify API] ← ワークフローで分析実行
    │       ↓
    │   JSON結果を返却
    ↓
[Supabase] ← 分析結果保存・デモデータ
```

---

## 3. 機能要件

### 3.1 相手リスト登録機能

ユーザーがバレンタインの対象者情報を登録する画面。

**入力データ:**

| 項目名         | 型       | 必須 | 説明                                        |
| -------------- | -------- | ---- | ------------------------------------------- |
| name           | string   | ○    | 対象者の名前（ニックネーム可）              |
| relationship   | enum     | ○    | 上司/同僚/友人/気になる人/パートナー/その他 |
| preferences    | string[] | —    | 甘党/お酒好き/健康志向 等のタグ             |
| gaveLastYear   | boolean  | —    | 去年渡したか                                |
| receivedReturn | boolean  | —    | ホワイトデーのお返しがあったか              |
| memo           | string   | —    | 自由記述（最近の関係性等）                  |

**UI要件:**

- テーブル形式での一覧入力（スプレッドシート風）
- 「+追加」ボタンで行を動的に追加
- relationship・preferencesはセレクト/タグ形式で選択
- デモ用サンプルデータをワンクリックで投入するボタン
- 総予算入力フィールド（円）

### 3.2 AI分析機能（Difyワークフロー）

Dify上に以下のステップでワークフローを構築する。

| Step | LLMノード             | 処理内容                                                                                         |
| ---- | --------------------- | ------------------------------------------------------------------------------------------------ |
| 1    | スコアリング          | 関係性の重要度 × 過去のROI × 今後の関係維持価値からS/A/B/Cランクを算出。ランク理由も生成。       |
| 2    | 予算配分 + ギフト提案 | ランクに応じた予算配分を決定。各人の好み × 予算枠 × 関係性に合ったギフトカテゴリ・価格帯を提案。 |
| 3    | メッセージ + 警告     | 関係性に応じたトーンでメッセージ文面を生成。リスク警告（重複ギフト等）も出力。                   |

### 3.3 ダッシュボード表示機能

AI分析結果をビジュアルに表示するダッシュボード画面。

- **ランク別カード一覧:** 各人のランク・ギフト提案・メッセージをカードUIで表示
- **予算配分グラフ:** 円グラフまたは棒グラフで配分を可視化（Recharts）
- **ROI予測表示:** 各人のホワイトデー回収確率・期待倍率
- **タイムライン:** 購入・準備・当日のスケジュール表示
- **リスク警告バナー:** 注意点をアラートUIで表示
- **カードクリックでメッセージ文面の詳細表示**（モーダル or アコーディオン）

### 3.4 デモ支援機能

- サンプルデータワンクリック投入ボタン（デモ時の入力時間短縮）
- LLM応答のフォールバックキャッシュ（API障害時に事前保存した結果を表示）

---

## 4. データモデル

### 4.1 Supabaseテーブル設計

**strategies テーブル:**

| カラム名        | 型          | 説明                         |
| --------------- | ----------- | ---------------------------- |
| id              | uuid (PK)   | 主キー                       |
| total_budget    | integer     | 総予算（円）                 |
| targets         | jsonb       | 対象者リスト（Target[]）     |
| analysis_result | jsonb       | AI分析結果（AnalysisResult） |
| created_at      | timestamptz | 作成日時                     |

### 4.2 LLM出力スキーマ（AnalysisResult）

Difyワークフローの最終出力として以下のJSON構造を返却する。

```
targets[]:
  id, rank (S/A/B/C), rankReason, allocatedBudget,
  giftSuggestion: { item, price, reason },
  message: string,
  roiPrediction: { returnProbability, expectedMultiplier }

timeline[]: { date, action }

warnings[]: string
```

---

## 5. API設計

| Method | Endpoint            | Request                     | Response              |
| ------ | ------------------- | --------------------------- | --------------------- |
| POST   | /api/analyze        | Strategy (targets + budget) | AnalysisResult (JSON) |
| GET    | /api/strategies/:id | —                           | 保存済み戦略の取得    |
| GET    | /api/demo-data      | —                           | デモ用サンプルデータ  |

**検討事項:**

- LLM応答時間: ストリーミング（SSE）vs ローディング待ち → デモ版はローディングで十分
- Vercel Serverless Functionのタイムアウト: Hobbyプランは10秒、Proは60秒
- Dify APIのレスポンスが遅い場合に備え、フォールバック用のキャッシュ機構を検討

---

## 6. 画面設計

### 6.1 画面一覧

| 画面名         | パス           | 概要                               |
| -------------- | -------------- | ---------------------------------- |
| トップ         | /              | ランディングページ・コンセプト説明 |
| 入力           | /strategy/new  | 相手リスト登録 + 予算入力          |
| ダッシュボード | /strategy/[id] | 分析結果表示（メイン画面）         |

### 6.2 ダッシュボード画面構成

- **ヘッダー:** タイトル + 総予算 + 対象人数のサマリ
- **メインエリア左側:** ランク別カードリスト（Sランクから順に表示）
- **メインエリア右側:** 予算配分円グラフ + ROI予測サマリ
- **ボトムエリア:** タイムライン + リスク警告バナー
- **カードクリックでメッセージ文面の詳細表示**（モーダル or アコーディオン）

---

## 7. 非機能要件

| 項目               | 要件                                                 |
| ------------------ | ---------------------------------------------------- |
| 認証               | なし（社内デモ用途のため不要）                       |
| レスポンス性能     | AI分析レスポンス: 30秒以内目標（ローディングUIあり） |
| 対象人数上限       | 最大20人（トークン数・UXのバランス）                 |
| 対応ブラウザ       | Chrome最新版（発表デモ環境）                         |
| レスポンシブ       | PC画面共有前提（モバイル対応はスコープ外）           |
| エラーハンドリング | LLMのJSONパース失敗時のリトライ + フォールバック表示 |

---

## 8. Dify環境構築

| 方式                  | メリット                                   | デメリット                     |
| --------------------- | ------------------------------------------ | ------------------------------ |
| **Dify Cloud (SaaS)** | セットアップ不要。すぐ使える。無料枠あり。 | 無料枠に制限あり。有料$59/月〜 |
| Self-host (Docker)    | コストはサーバー代のみ。制限なし。         | インフラ構築の手間が発生       |

> **推奨:** デモ版であればDify Cloudの無料枠 / Sandboxプランで十分。セルフホストは発表までの工数と相談。

---

## 9. 開発スケジュール

| #   | タスク                                     | 目安 | 備考                             |
| --- | ------------------------------------------ | ---- | -------------------------------- |
| 1   | Difyワークフロー構築 + プロンプト設計      | 3-4h | 最優先。出力品質の確認           |
| 2   | Next.js + Supabaseプロジェクトセットアップ | 1-2h | プロジェクト初期化・テーブル作成 |
| 3   | API Routes実装（Dify API連携）             | 2-3h | /api/analyze エンドポイント      |
| 4   | 入力フォームUI実装                         | 3-4h | テーブル入力 + デモデータボタン  |
| 5   | ダッシュボードUI実装                       | 4-5h | カード + グラフ + タイムライン   |
| 6   | デモデータ・フォールバック準備             | 1-2h | API障害時の安全網                |
| 7   | デプロイ・動作確認                         | 1-2h | Vercelデプロイ + E2E確認         |
| 8   | 発表スライド作成                           | 2-3h | セールス応用対比表含む           |

**合計見積: 約18〜25時間**

---

## 10. リスク・課題

| リスク                       | 影響                 | 対策                                        |
| ---------------------------- | -------------------- | ------------------------------------------- |
| LLMがJSON形式を守らない      | フロントがクラッシュ | Dify側で出力形式指定 + パース失敗時リトライ |
| ギフト価格のハルシネーション | 提案の信頼性低下     | 価格帯のみ提示。具体商品名は避ける          |
| デモ中のAPI障害              | 発表が止まる         | 事前キャッシュした結果でフォールバック      |
| Vercelタイムアウト           | APIレスポンス失敗    | Difyのワークフローを軽量化 or Proプラン検討 |
| Dify Cloud無料枠上限         | 開発中に使い切る     | プランアップ or セルフホストに切替          |

---

## 11. スコープ外（今回対象外）

- ユーザー認証・ログイン機能
- モバイルレスポンシブ対応
- 複数ユーザー対応・データ分離
- ECサイトとの連携（実際の商品検索・購入）
- セールス向け本番機能の実装（別フェーズで検討）
- 多言語対応
